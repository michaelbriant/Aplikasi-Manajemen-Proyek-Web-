{% extends "base.html" %}

{% block content %}
<style>
    /* Styling Global untuk Halaman Integrasi */
    .integration-container {
        max-width: 900px; /* Lebar maksimum sedikit lebih lebar */
        margin: 40px auto; /* Pusatkan kontainer */
        padding: 30px; /* Padding lebih banyak */
        background: linear-gradient(135deg, #f5faff 0%, #e0ecf7 100%); /* Gradien biru muda lembut */
        border-radius: 12px; /* Sudut lebih membulat */
        box-shadow: 0 8px 25px rgba(0,0,0,0.1); /* Bayangan lebih dalam */
        color: #333; /* Warna teks default */
        border: 1px solid #cce0f0; /* Border lembut */
    }

    .integration-container h2 {
        color: #1a2b44; /* Biru gelap untuk judul utama */
        font-weight: 700; /* Judul lebih tebal */
        font-size: 28px; /* Judul lebih besar */
        text-align: center; /* Pusatkan judul */
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0eaf1; /* Garis pemisah lebih menonjol */
    }

    /* Styling Elemen Form */
    .form-group {
        margin-bottom: 25px; /* Jarak lebih banyak antar grup form */
    }

    .form-group label {
        font-weight: 600; /* Label lebih tebal */
        color: #333; /* Warna teks label lebih gelap */
        margin-bottom: 8px; /* Jarak antara label dan select */
        display: block; /* Pastikan label mengambil lebar penuh */
        font-size: 15px;
    }

    .form-group select {
        width: 100%;
        padding: 12px 15px; /* Padding lebih banyak */
        border-radius: 8px; /* Lebih membulat */
        border: 1px solid #a3c1da; /* Border lebih lembut */
        background-color: #ffffff; /* Latar belakang putih untuk select */
        color: #333; /* Teks gelap untuk select */
        font-size: 15px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Bayangan dalam untuk efek kedalaman */
        -webkit-appearance: none; /* Hapus panah select default */
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a2b44'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); /* Panah kustom */
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 18px;
    }

    /* Styling Tombol */
    #check-button {
        background: linear-gradient(90deg, #4a90e2 0%, #2e66b4 100%); /* Tombol gradien biru */
        color: white;
        border: none;
        padding: 14px 30px; /* Padding lebih besar */
        border-radius: 8px; /* Sudut membulat */
        font-size: 16px; /* Ukuran font lebih besar */
        font-weight: 600; /* Teks lebih tebal */
        cursor: pointer;
        width: auto;
        display: block; /* Jadikan blok agar bisa dipusatkan dengan margin auto */
        margin: 20px auto 30px auto; /* Pusatkan tombol */
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Bayangan untuk tombol */
        transition: all 0.3s ease; /* Transisi halus */
    }

    #check-button:hover {
        background: linear-gradient(90deg, #367ac8 0%, #22518e 100%);
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        transform: translateY(-2px); /* Efek sedikit terangkat */
    }

    #check-button:disabled {
        background: #aabfdd;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Styling Area Hasil */
    #status-result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 10px; /* Agak membulat */
        min-height: 20px;
        border-left: 5px solid #4a90e2; /* Border kiri lebih tebal */
        color: #333;
        background-color: #ffffff; /* Latar belakang putih untuk bagian hasil */
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); /* Bayangan lembut */
    }

    #status-result.error {
        background-color: #ffeaea; /* Merah muda */
        border-left-color: #e53e3e; /* Merah lebih gelap */
        color: #c53030;
    }

    #status-result.success {
        background-color: #e9fff1; /* Hijau muda */
        border-left-color: #38a169; /* Hijau lebih gelap */
        color: #2f855a;
    }

    /* Styling Kartu untuk Bagian Data */
    .data-card {
        background-color: #f7f9fc; /* Latar belakang sangat terang untuk kartu di dalam */
        border: 1px solid #e1eaf1; /* Border lembut */
        border-radius: 10px; /* Pembulatan konsisten */
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* Bayangan lebih jelas */
        transition: all 0.2s ease;
        overflow: hidden; /* Pastikan konten tidak meluber */
    }

    .data-card:hover {
        transform: translateY(-2px); /* Sedikit terangkat saat hover */
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    /* Judul modul utama di dalam kartu data */
    .data-card h3 {
        color: #1a2b44;
        font-size: 22px; /* Judul lebih besar */
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #d1e0f0; /* Garis pemisah putus-putus */
    }

    /* Judul bagian di dalam kartu */
    .data-card h4 {
        color: #4a90e2; /* Biru untuk judul bagian */
        font-size: 18px;
        margin-top: 15px; /* Jarak di atas judul bagian */
        margin-bottom: 12px;
        font-weight: 600;
    }

    .data-card div strong {
        color: #555; /* Teks lebih gelap untuk label */
        font-weight: 600;
        display: inline-block;
        min-width: 120px; /* Sejajarkan label jika diperlukan */
        vertical-align: top;
    }

    .data-card div {
        margin-bottom: 8px;
        line-height: 1.6;
        color: #444; /* Warna teks default untuk nilai */
    }

    /* Penyesuaian khusus untuk item daftar seperti milestones */
    .data-card ul {
        list-style-type: none; /* Hapus bullet default */
        padding-left: 0;
        margin-top: 10px;
    }

    .data-card ul li {
        margin-bottom: 5px;
        background-color: #eaf3fb; /* Latar belakang terang untuk item daftar */
        padding: 8px 12px;
        border-radius: 6px;
        border-left: 3px solid #4a90e2;
    }

    /* Penyesuaian responsif */
    @media (max-width: 768px) {
        .integration-container {
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
        }
        .integration-container h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #check-button {
            width: 100%;
            padding: 12px 20px;
            font-size: 15px;
        }
        .form-group select, .form-group input {
            font-size: 14px;
            padding: 10px 12px;
        }
        .data-card {
            padding: 15px;
        }
        .data-card h3 {
            font-size: 18px;
        }
        .data-card h4 {
            font-size: 16px;
        }
        .data-card div strong {
            display: block; /* Label di atas nilai di mobile */
            min-width: unset;
            margin-bottom: 5px;
        }
    }
</style>

<div class="integration-container">
    <h2>Manajemen Proyek - Integrasi Modul</h2>

    <div class="form-group">
        <label for="modul-select">Pilih Modul:</label>
        <select id="modul-select">
            <option value="">-- Pilih --</option>
            <option value="ie">Intelligence Engineering</option>
            <option value="ic">Intelligence Creation</option>
            <option value="imp">Implementation</option>
        </select>
    </div>

    <div class="form-group">
        <label for="project-select">Pilih Proyek:</label>
        <select id="project-select">
            {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
        </select>
    </div>

    <button id="check-button">
        Periksa Status & Detail
    </button>

    <div id="status-result" class="loading">Memuat data...</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const checkButton = document.getElementById("check-button");
    const resultDiv = document.getElementById("status-result");
    const modulSelect = document.getElementById("modul-select");
    const projectSelect = document.getElementById("project-select");

    // Pemetaan URL API untuk setiap modul
    const apiEndpoints = {
        'ie': {
            'status': "https://fabyaanusakti.pythonanywhere.com/api/status-only/",
            'detail': "https://fabyaanusakti.pythonanywhere.com/api/projek-data/"
        },
        'ic': {
            'main': "https://arlellll.pythonanywhere.com/api-content/project-statuses/"
        },
        'imp': {
            'status': "https://tasana.pythonanywhere.com/api/project-status/"
        }
    };

    checkButton.addEventListener("click", async function () {
        const modul = modulSelect.value;
        const selectedProjectId = parseInt(projectSelect.value); // Pastikan ini adalah angka

        if (!modul || !selectedProjectId) {
            showResult("Silakan pilih modul dan proyek terlebih dahulu", "error");
            return;
        }

        checkButton.textContent = "Memeriksa...";
        checkButton.disabled = true;
        resultDiv.innerHTML = "Memuat data...";
        resultDiv.className = "loading";

        let html = "";
        let statusFetched = false;

        try {
            if (modul === 'ie') {
                const [statusRes, detailRes] = await Promise.all([
                    fetch(apiEndpoints.ie.status),
                    fetch(apiEndpoints.ie.detail)
                ]);

                const statusList = await statusRes.json();
                const projekList = await detailRes.json();

                const statusProyek = statusList.find(p => p.id === selectedProjectId);
                const detailProyek = projekList.find(p => p.id_projek === selectedProjectId);

                html += `<h3>Integrasi Modul Intelligence Engineering (IE)</h3>`; // Judul modul utama di hasil
                if (statusProyek) {
                    html += `<div class="data-card"><h4>Status Proyek:</h4><p><strong>Status:</strong> ${statusProyek.status}</p></div>`;
                    statusFetched = true;
                }

                if (detailProyek) {
                    // Meaningful Objectives
                    const meaningfulObjectives = Object.values(detailProyek.meaningful_objectives || {}).some(v => v && v !== "-");
                    if (meaningfulObjectives) {
                        html += `<div class="data-card"><h4>üéØ Meaningful Objectives</h4>`;
                        for (const [key, value] of Object.entries(detailProyek.meaningful_objectives)) {
                            if (value && value !== "-") {
                                html += `<div><strong>${formatKey(key)}:</strong> ${value}</div>`;
                            }
                        }
                        html += `</div>`;
                    }

                    // Intelligence Experience
                    const intelligenceExperience = Object.values(detailProyek.intelligence_experience || {}).some(v => v && v !== "-");
                    if (intelligenceExperience) {
                        html += `<div class="data-card"><h4>üß† Intelligence Experience</h4>`;
                        for (const [key, value] of Object.entries(detailProyek.intelligence_experience)) {
                            if (value && value !== "-") {
                                html += `<div><strong>${formatKey(key)}:</strong> ${value}</div>`;
                            }
                        }
                        html += `</div>`;
                    }

                    // Intelligence Implementation
                    const intelligenceImplementation = Object.values(detailProyek.intelligence_implementation || {}).some(v => v && v !== "-");
                    if (intelligenceImplementation) {
                        html += `<div class="data-card"><h4>üîß Intelligence Implementation</h4>`;
                        for (const [key, value] of Object.entries(detailProyek.intelligence_implementation)) {
                            if (!["last_edited", "last_edited_by"].includes(key) && value && value !== "-") {
                                html += `<div><strong>${formatKey(key)}:</strong> ${value}</div>`;
                            }
                        }
                        html += `</div>`;
                    }

                    // Batasan Pengembangan
                    if (detailProyek.batasan_pengembangan?.limitation && detailProyek.batasan_pengembangan.limitation !== "-") {
                        html += `<div class="data-card"><h4>‚ö†Ô∏è Batasan Pengembangan</h4>`;
                        html += `<div><strong>Limitation:</strong> ${detailProyek.batasan_pengembangan.limitation}</div>`;
                        html += `</div>`;
                    }

                    // Status Realisasi
                    if (detailProyek.status_realisasi?.realization && detailProyek.status_realisasi.realization !== "-") {
                        html += `<div class="data-card"><h4>üöÄ Status Realisasi</h4>`;
                        html += `<div><strong>Realization:</strong> ${detailProyek.status_realisasi.realization}</div>`;
                        html += `</div>`;
                    }

                    // Perencanaan
                    const perencanaan = Object.values(detailProyek.perencanaan || {}).some(v => v && v !== "-");
                    if (perencanaan) {
                        html += `<div class="data-card"><h4>üìÖ Perencanaan</h4>`;
                        for (const [key, value] of Object.entries(detailProyek.perencanaan)) {
                            if (!["last_edited", "last_edited_by"].includes(key) && value && value !== "-") {
                                html += `<div><strong>${formatKey(key)}:</strong> ${value}</div>`;
                            }
                        }
                        html += `</div>`;
                    }
                } else if (!statusProyek && html === `<h3>Integrasi Modul Intelligence Engineering (IE)</h3>`) { // Jika hanya judul modul yang ditambahkan dan tidak ada data
                    html += `<em>Data detail proyek tidak ditemukan di modul IE.</em>`;
                }

            } else if (modul === 'ic') {
                const response = await fetch(apiEndpoints.ic.main);
                const projectDataList = await response.json(); // Ini adalah daftar, bukan satu objek

                // Menggunakan external_id untuk modul IC, dikonversi ke string untuk perbandingan
                const projectData = projectDataList.find(p => String(p.external_id) === String(selectedProjectId));

                html += `<h3>Integrasi Modul Intelligence Creation (IC)</h3>`;
                if (projectData) {
                    // Menggunakan status_proyek_ic untuk modul IC
                    html += `<div class="data-card"><h4>Status Proyek:</h4><p><strong>Status:</strong> ${projectData.status_proyek_ic}</p></div>`;
                    statusFetched = true;

                    html += `<div class="data-card"><h4>üìã Detail Pekerjaan (dari IC)</h4>`;
                    if (projectData.nama_proyek) html += `<div><strong>Nama Proyek:</strong> ${projectData.nama_proyek}</div>`;
                    // Deskripsi proyek utama mungkin berada di entri 'pekerjaan' pertama
                    if (projectData.pekerjaan && projectData.pekerjaan[0] && projectData.pekerjaan[0].deskripsi_pekerjaan) {
                         html += `<div><strong>Deskripsi Utama:</strong> ${projectData.pekerjaan[0].deskripsi_pekerjaan}</div>`;
                    }
                    if (projectData.tanggal_mulai) html += `<div><strong>Tanggal Mulai:</strong> ${projectData.tanggal_mulai}</div>`;
                    if (projectData.tanggal_selesai) html += `<div><strong>Tanggal Selesai:</strong> ${projectData.tanggal_selesai}</div>`;

                    // Tangani daftar 'pekerjaan' (tugas/job)
                    if (projectData.pekerjaan && projectData.pekerjaan.length > 0) {
                        html += `<h4>Daftar Pekerjaan:</h4>`;
                        html += `<ul>`; // Mulai daftar tak berurutan untuk pekerjaan
                        projectData.pekerjaan.forEach(pekerjaan => {
                            html += `<li>`; // Setiap pekerjaan adalah item daftar
                            html += `<strong>${pekerjaan.nama_pekerjaan || 'Nama Tidak Diketahui'}</strong> (Status: ${pekerjaan.status || 'N/A'})<br>`;
                            if (pekerjaan.deskripsi_pekerjaan) html += `&nbsp;&nbsp;&nbsp;&nbsp;Deskripsi: ${pekerjaan.deskripsi_pekerjaan}<br>`;
                            if (pekerjaan.lokasi) html += `&nbsp;&nbsp;&nbsp;&nbsp;Lokasi: ${pekerjaan.lokasi}<br>`;
                            if (pekerjaan.tanggal_mulai && pekerjaan.tanggal_selesai) html += `&nbsp;&nbsp;&nbsp;&nbsp;Periode: ${pekerjaan.tanggal_mulai} - ${pekerjaan.tanggal_selesai}<br>`;
                            if (pekerjaan.pelaksana_pekerjaan) html += `&nbsp;&nbsp;&nbsp;&nbsp;Pelaksana: ${pekerjaan.pelaksana_pekerjaan}<br>`;
                            if (pekerjaan.supervisor_pekerjaan) html += `&nbsp;&nbsp;&nbsp;&nbsp;Supervisor: ${pekerjaan.supervisor_pekerjaan}<br>`;

                            // Tangani 'aktivitas' di dalam setiap 'pekerjaan'
                            if (pekerjaan.aktivitas && pekerjaan.aktivitas.length > 0) {
                                html += `&nbsp;&nbsp;&nbsp;&nbsp;Aktivitas:<br>`;
                                html += `&nbsp;&nbsp;&nbsp;&nbsp;<ul>`; // Daftar bersarang untuk aktivitas
                                pekerjaan.aktivitas.forEach(aktivitas => {
                                    html += `&nbsp;&nbsp;&nbsp;&nbsp;<li>&bull; <strong>${aktivitas.nama_aktivitas || 'Nama Tidak Diketahui'}</strong> (Waktu: ${aktivitas.waktu_pelaksanaan ? new Date(aktivitas.waktu_pelaksanaan).toLocaleDateString('id-ID') : 'N/A'}, Pelaksana: ${aktivitas.pelaksana_aktivitas || 'N/A'})</li>`;
                                });
                                html += `&nbsp;&nbsp;&nbsp;&nbsp;</ul>`;
                            }
                            html += `</li>`;
                        });
                        html += `</ul>`;
                    }
                    html += `</div>`;
                } else {
                    html += `<em>Data proyek tidak ditemukan di modul IC.</em>`;
                }

            } else if (modul === 'imp') {
                const response = await fetch(apiEndpoints.imp.status);
                const projectStatuses = await response.json();

                // Menggunakan 'id' untuk modul IMP, membandingkan angka
                const projectStatus = projectStatuses.find(p => p.id === selectedProjectId);

                html += `<h3>Integrasi Modul Implementation (IMP)</h3>`;
                if (projectStatus) {
                    html += `<div class="data-card"><h4>Status Proyek:</h4><p><strong>Nama Proyek:</strong> ${projectStatus.nama_proyek || 'Tidak Diketahui'}<br><strong>Status:</strong> ${projectStatus.status}</p></div>`;
                    statusFetched = true;
                    // Catatan: API IMP yang disediakan hanya memberikan nama proyek dan status, tidak detail tugas/aktivitas
                } else {
                    html += `<em>Status proyek tidak ditemukan di modul Implementation.</em>`;
                }
            }

            if (!statusFetched && html === "") {
                showResult("Data proyek tidak ditemukan di modul ini.", "error");
            } else {
                showResult(html, "success");
            }

        } catch (error) {
            showResult("‚ùå Gagal mengambil data. Pastikan API tersedia dan ID proyek benar.", "error");
            console.error("Error fetching data:", error);
        } finally {
            checkButton.textContent = "Periksa Status & Detail";
            checkButton.disabled = false;
        }
    });

    function showResult(message, type) {
        resultDiv.innerHTML = message;
        resultDiv.className = type;
    }

    function formatKey(key) {
        // Fungsi untuk memformat kunci dari snake_case menjadi Judul Biasa
        return key.replace(/_/g, " ").replace(/\b\w/g, char => char.toUpperCase());
    }
});
</script>
{% endblock %}